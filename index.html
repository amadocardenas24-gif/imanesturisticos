#!/usr/bin/env python3
"""
GENERADOR AUTOM√ÅTICO DE PROYECTOS AR PARA VIDEOS
=================================================
Instrucciones:
1. Coloca este script en una carpeta
2. Dentro de esa carpeta, a√±ade tus 3 archivos:
   - imagen_target.jpg/png (imagen para reconocer)
   - video.mp4 (video a reproducir)
   - target.mind (modelo entrenado de MindAR)
3. Ejecuta: python generador_ar.py
4. Se generar√° un ZIP listo para subir a hosting

Requisitos: Python 3.6+
"""

import os
import shutil
import zipfile
import sys
from datetime import datetime
from pathlib import Path

class ARSimpleGenerator:
    def __init__(self):
        self.project_name = "experiencia_ar"
        self.files_needed = {
            'target_image': None,
            'video': None,
            'mind_file': None
        }
        
    def detect_files(self):
        """Detecta autom√°ticamente los archivos en la carpeta actual"""
        print("üîç Buscando archivos necesarios...")
        
        for file in os.listdir('.'):
            file_lower = file.lower()
            
            # Detectar imagen target
            if file_lower.endswith(('.jpg', '.jpeg', '.png', '.webp')):
                if 'target' in file_lower or 'image' in file_lower or 'imagen' in file_lower:
                    self.files_needed['target_image'] = file
                    print(f"   ‚úÖ Imagen target encontrada: {file}")
                elif not self.files_needed['target_image']:
                    self.files_needed['target_image'] = file
                    print(f"   ‚úÖ Imagen encontrada: {file}")
            
            # Detectar video
            elif file_lower.endswith(('.mp4', '.webm', '.ogv', '.mov')):
                self.files_needed['video'] = file
                print(f"   ‚úÖ Video encontrado: {file}")
            
            # Detectar archivo .mind
            elif file_lower.endswith('.mind'):
                self.files_needed['mind_file'] = file
                print(f"   ‚úÖ Archivo .mind encontrado: {file}")
        
        return all(self.files_needed.values())
    
    def create_html(self, project_folder):
        """Crea el archivo HTML principal"""
        html_content = f'''<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Video - {self.files_needed['target_image']}</title>
    
    <!-- MindAR sin A-Frame (solo para video) -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body, html {{
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }}
        
        /* Contenedor de video */
        #video-container {{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 100;
        }}
        
        #ar-video {{
            width: 100%;
            height: 100%;
            object-fit: cover;
        }}
        
        /* Contenedor AR */
        #ar-container {{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }}
        
        /* Botones de control */
        #control-panel {{
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 1000;
        }}
        
        .control-btn {{
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            padding: 12px 24px;
            margin: 0 10px;
            border-radius: 30px;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }}
        
        .control-btn:hover {{
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }}
        
        /* Mensajes */
        #message {{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            display: none;
            z-index: 1001;
            text-align: center;
            max-width: 80%;
        }}
    </style>
</head>
<body>
    <!-- Contenedor AR -->
    <div id="ar-container">
        <!-- Video AR se inyectar√° aqu√≠ -->
    </div>
    
    <!-- Contenedor para video a pantalla completa -->
    <div id="video-container">
        <video id="ar-video" controls>
            <source src="{self.files_needed['video']}" type="video/mp4">
            Tu navegador no soporta video HTML5.
        </video>
    </div>
    
    <!-- Panel de control -->
    <div id="control-panel">
        <button class="control-btn" onclick="startAR()">‚ñ∂ Iniciar AR</button>
        <button class="control-btn" onclick="showVideoFullscreen()">üì∫ Ver Video</button>
        <button class="control-btn" onclick="stopAR()">‚èπ Detener</button>
    </div>
    
    <!-- Mensajes -->
    <div id="message"></div>
    
    <script>
        let mindarThree = null;
        let videoPlaying = false;
        
        // Funci√≥n para mostrar mensajes
        function showMessage(text, duration = 3000) {{
            const message = document.getElementById('message');
            message.textContent = text;
            message.style.display = 'block';
            setTimeout(() => {{
                message.style.display = 'none';
            }}, duration);
        }}
        
        // Iniciar AR
        async function startAR() {{
            try {{
                showMessage("üöÄ Iniciando realidad aumentada...");
                
                // Inicializar MindAR
                mindarThree = new window.MINDAR.IMAGE.MindARThree({{
                    container: document.getElementById('ar-container'),
                    imageTargetSrc: './{self.files_needed['mind_file']}'
                }});
                
                const {{ renderer, scene, camera }} = mindarThree;
                
                // Crear video como textura
                const video = document.createElement('video');
                video.src = './{self.files_needed['video']}';
                video.loop = true;
                video.muted = true;
                video.playsInline = true;
                
                const videoTexture = new THREE.VideoTexture(video);
                
                // Crear plano para mostrar el video
                const geometry = new THREE.PlaneGeometry(1, 0.5625); // 16:9
                const material = new THREE.MeshBasicMaterial({{ map: videoTexture }});
                const plane = new THREE.Mesh(geometry, material);
                
                // Crear anchor (punto de anclaje)
                const anchor = mindarThree.addAnchor(0);
                anchor.group.add(plane);
                
                // Iniciar MindAR
                await mindarThree.start();
                
                // Reproducir video cuando se detecte
                anchor.onTargetFound = () => {{
                    video.play();
                    videoPlaying = true;
                    showMessage("‚úÖ ¬°Imagen detectada! Reproduciendo video...", 2000);
                }};
                
                anchor.onTargetLost = () => {{
                    video.pause();
                    videoPlaying = false;
                }};
                
                // Render loop
                renderer.setAnimationLoop(() => {{
                    renderer.render(scene, camera);
                }});
                
                showMessage("‚úÖ AR listo. Enfoca la imagen target con tu c√°mara.", 3000);
                
            }} catch (error) {{
                console.error("Error al iniciar AR:", error);
                showMessage("‚ùå Error al iniciar AR. Aseg√∫rate de permitir el acceso a la c√°mara.");
            }}
        }}
        
        // Mostrar video a pantalla completa
        function showVideoFullscreen() {{
            const videoContainer = document.getElementById('video-container');
            const video = document.getElementById('ar-video');
            
            videoContainer.style.display = 'block';
            video.play();
            
            // Ocultar cuando termine
            video.onended = function() {{
                videoContainer.style.display = 'none';
            }};
        }}
        
        // Detener AR
        function stopAR() {{
            if (mindarThree) {{
                mindarThree.stop();
                mindarThree = null;
            }}
            
            // Ocultar video
            document.getElementById('video-container').style.display = 'none';
            
            showMessage("‚èπ AR detenido");
        }}
        
        // Cerrar video fullscreen
        document.getElementById('video-container').addEventListener('click', function(e) {{
            if (e.target.id === 'video-container') {{
                this.style.display = 'none';
                const video = document.getElementById('ar-video');
                video.pause();
                video.currentTime = 0;
            }}
        }});
        
        // Iniciar autom√°ticamente al cargar la p√°gina
        window.addEventListener('load', () => {{
            showMessage("üì± Apunta con tu c√°mara a la imagen target", 2000);
        }});
    </script>
</body>
</html>'''
        
        html_path = os.path.join(project_folder, 'index.html')
        with open(html_path, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        print(f"   ‚úÖ index.html creado")
        return html_path
    
    def copy_files(self, project_folder):
        """Copia los archivos necesarios a la carpeta del proyecto"""
        for file_type, filename in self.files_needed.items():
            if filename:
                shutil.copy2(filename, os.path.join(project_folder, filename))
                print(f"   ‚úÖ {filename} copiado")
    
    def create_zip(self, project_folder):
        """Crea archivo ZIP del proyecto"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        zip_filename = f"ar_project_{timestamp}.zip"
        
        with zipfile.ZipFile(zip_filename, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for root, dirs, files in os.walk(project_folder):
                for file in files:
                    file_path = os.path.join(root, file)
                    arcname = os.path.relpath(file_path, project_folder)
                    zipf.write(file_path, arcname)
        
        print(f"\nüéâ ZIP creado: {zip_filename}")
        print(f"üìÅ Tama√±o: {os.path.getsize(zip_filename) / 1024:.1f} KB")
        return zip_filename
    
    def clean_temp(self, project_folder):
        """Elimina carpeta temporal"""
        if os.path.exists(project_folder):
            shutil.rmtree(project_folder)
            print(f"   üßπ Carpeta temporal eliminada")
    
    def generate(self):
        """Funci√≥n principal que genera el proyecto"""
        print("\n" + "="*50)
        print("    GENERADOR AUTOM√ÅTICO AR - SOLO VIDEOS")
        print("="*50)
        
        # Paso 1: Detectar archivos
        if not self.detect_files():
            print("\n‚ùå ERROR: Faltan archivos necesarios.")
            print("Necesitas estos 3 archivos en la carpeta:")
            print("   1. imagen_target.jpg/png (imagen para reconocer)")
            print("   2. video.mp4 (video a mostrar en AR)")
            print("   3. target.mind (archivo .mind de MindAR)")
            sys.exit(1)
        
        # Mostrar resumen
        print("\nüìã RESUMEN DE ARCHIVOS:")
        for file_type, filename in self.files_needed.items():
            size = os.path.getsize(filename) / 1024
            print(f"   ‚Ä¢ {filename}: {size:.1f} KB")
        
        # Paso 2: Crear carpeta temporal
        temp_folder = "temp_ar_project"
        if os.path.exists(temp_folder):
            shutil.rmtree(temp_folder)
        os.makedirs(temp_folder)
        print(f"\nüìÅ Carpeta temporal creada: {temp_folder}")
        
        # Paso 3: Crear HTML
        print("\nüõ†Ô∏è Generando proyecto...")
        self.create_html(temp_folder)
        
        # Paso 4: Copiar archivos
        self.copy_files(temp_folder)
        
        # Paso 5: Crear ZIP
        print("\nüì¶ Comprimiendo en ZIP...")
        zip_file = self.create_zip(temp_folder)
        
        # Paso 6: Limpiar
        self.clean_temp(temp_folder)
        
        # Instrucciones finales
        print("\n" + "="*50)
        print("üéØ ¬°PROYECTO LISTO!")
        print("="*50)
        print("\nüìù INSTRUCCIONES PARA USAR:")
        print("1. Sube el archivo ZIP a tu hosting")
        print("2. Descomprime el ZIP en tu servidor")
        print("3. Accede a index.html desde un dispositivo m√≥vil")
        print("4. Aseg√∫rate de usar HTTPS para que funcione la c√°mara")
        print("\nüîó URL de ejemplo: https://tudominio.com/ar_project/")
        print("\nüí° Consejo: Usa un servicio gratuito como:")
        print("   ‚Ä¢ Netlify: arrastra la carpeta descomprimida")
        print("   ‚Ä¢ GitHub Pages: sube los archivos a un repo")
        print("   ‚Ä¢ Vercel: similar a Netlify")
        
        return zip_file

def main():
    """Funci√≥n principal"""
    try:
        generator = ARSimpleGenerator()
        zip_file = generator.generate()
        
        # Preguntar si abrir carpeta
        if sys.platform == "win32":
            os.startfile(os.path.dirname(zip_file))
        elif sys.platform == "darwin":
            os.system(f"open {os.path.dirname(zip_file)}")
        
    except Exception as e:
        print(f"\n‚ùå Error inesperado: {e}")
        print("Por favor, aseg√∫rate de que:")
        print("1. Tienes Python 3.6+ instalado")
        print("2. Los archivos est√°n en la misma carpeta que este script")
        print("3. Tienes permisos de escritura")
        sys.exit(1)

if __name__ == "__main__":
    main()
