<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Imanes Tur√≠sticos AR - Triple Frontera</title>
    
    <!-- A-Frame y MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        /* ================= RESET Y BASE ================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            font-family: 'Arial', sans-serif;
            background: #000;
        }

        /* ================= PANTALLA DE CARGA ================= */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .logo-ar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff9a00, #ff5e00);
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 2s infinite;
            box-shadow: 0 0 30px rgba(255, 154, 0, 0.5);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .logo-inner {
            width: 100px;
            height: 100px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            font-weight: bold;
        }

        .title-main {
            color: white;
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .title-sub {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            margin-bottom: 30px;
            max-width: 400px;
            line-height: 1.4;
        }

        /* ================= PERMISOS ================= */
        #permission-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }

        .permission-box {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .permission-icon {
            font-size: 60px;
            margin-bottom: 20px;
            display: block;
        }

        .permission-title {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .permission-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 25px;
        }

        #permission-btn {
            padding: 12px 30px;
            background: linear-gradient(45deg, #00b09b, #96c93d);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s;
        }

        #permission-btn:hover {
            transform: scale(1.05);
        }

        /* ================= ESCENA AR ================= */
        #ar-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.5s;
        }

        /* ================= CONTROLES ================= */
        #exit-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(231, 76, 60, 0.9);
            border: 2px solid white;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: none;
            z-index: 100;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        #ar-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.9);
            border: 2px solid white;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }

        /* ================= INDICADOR ================= */
        #detection-indicator {
            position: fixed;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: none;
            z-index: 100;
            border: 2px solid #FF9800;
        }

        /* ================= OCULTAR UI DE A-FRAME ================= */
        .a-enter-vr, .a-enter-ar, .vr-button, .ar-button,
        .a-orientation-modal, .a-dialog, .a-modal,
        .mindar-ui-overlay, .a-loader-title {
            display: none !important;
        }

        /* ================= RESPONSIVE ================= */
        @media (max-width: 768px) {
            .logo-ar {
                width: 100px;
                height: 100px;
            }
            
            .logo-inner {
                width: 80px;
                height: 80px;
                font-size: 30px;
            }
            
            .title-main {
                font-size: 1.5rem;
            }
            
            .title-sub {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- ================= PANTALLA DE PERMISOS ================= -->
    <div id="permission-screen">
        <div class="permission-box">
            <div class="permission-icon">üì±</div>
            <h2 class="permission-title">Permiso de C√°mara</h2>
            <p class="permission-text">
                Para usar la experiencia AR, necesitamos acceso a tu c√°mara. Esto nos permitir√° escanear los imanes tur√≠sticos.
            </p>
            <p class="permission-text">
                El acceso a la c√°mara es solo para detectar los marcadores, no grabamos ni almacenamos im√°genes.
            </p>
            <button id="permission-btn">PERMITIR C√ÅMARA</button>
        </div>
    </div>

    <!-- ================= PANTALLA DE CARGA ================= -->
    <div id="loading-screen">
        <div class="logo-ar">
            <div class="logo-inner">AR</div>
        </div>
        
        <h1 class="title-main">IMANES TUR√çSTICOS AR</h1>
        <p class="title-sub">Escanea tus imanes de la Triple Frontera para ver contenido exclusivo</p>
        
        <div style="margin-top: 30px; color: rgba(255,255,255,0.7); font-size: 0.9rem;">
            Cargando experiencia...
        </div>
    </div>

    <!-- ================= ESCENA AR ================= -->
    <div id="ar-scene">
        <!-- Se llenar√° din√°micamente -->
    </div>

    <!-- ================= CONTROLES ================= -->
    <button id="exit-btn" title="Salir">‚úï</button>
    
    <div id="ar-controls">
        <button class="control-btn" id="sound-btn" title="Sonido">üîä</button>
        <button class="control-btn" id="help-btn" title="Ayuda">?</button>
    </div>
    
    <div id="detection-indicator">
        üîç Buscando marcador...
    </div>

    <script>
        // ================= ESTADO GLOBAL =================
        let arScene = null;
        let arSystem = null;
        let soundEnabled = true;
        let audioContext = null;
        let hasCameraPermission = false;

        // ================= INICIALIZACI√ìN =================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando aplicaci√≥n AR');
            
            // Mostrar pantalla de permisos despu√©s de un breve retraso
            setTimeout(() => {
                showPermissionScreen();
            }, 1000);
            
            // Configurar botones
            document.getElementById('permission-btn').addEventListener('click', requestCameraPermission);
            document.getElementById('exit-btn').addEventListener('click', exitARExperience);
            document.getElementById('sound-btn').addEventListener('click', toggleSound);
            document.getElementById('help-btn').addEventListener('click', showHelp);
        });

        // ================= PERMISOS =================
        function showPermissionScreen() {
            document.getElementById('permission-screen').style.display = 'flex';
        }

        function hidePermissionScreen() {
            document.getElementById('permission-screen').style.display = 'none';
        }

        function requestCameraPermission() {
            console.log('üì∑ Solicitando permiso de c√°mara...');
            
            // Crear un video temporal para solicitar permisos
            const tempVideo = document.createElement('video');
            tempVideo.setAttribute('autoplay', '');
            tempVideo.setAttribute('muted', '');
            tempVideo.setAttribute('playsinline', '');
            tempVideo.style.display = 'none';
            document.body.appendChild(tempVideo);
            
            // Solicitar stream de video
            navigator.mediaDevices.getUserMedia({ 
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            })
            .then(stream => {
                console.log('‚úÖ Permiso de c√°mara concedido');
                hasCameraPermission = true;
                
                // Detener el stream temporal
                stream.getTracks().forEach(track => track.stop());
                document.body.removeChild(tempVideo);
                
                // Ocultar pantalla de permisos
                hidePermissionScreen();
                
                // Inicializar audio
                initAudio();
                
                // Iniciar experiencia AR
                setTimeout(initARExperience, 500);
            })
            .catch(error => {
                console.error('‚ùå Error al obtener permiso de c√°mara:', error);
                document.body.removeChild(tempVideo);
                
                // Mostrar mensaje de error
                const permissionBox = document.querySelector('.permission-box');
                permissionBox.innerHTML = `
                    <div class="permission-icon">‚ùå</div>
                    <h2 class="permission-title">Permiso Denegado</h2>
                    <p class="permission-text">
                        No podemos acceder a tu c√°mara. Por favor:
                    </p>
                    <ol style="text-align: left; color: rgba(255,255,255,0.8); margin: 15px 0; padding-left: 20px;">
                        <li>Verifica los permisos de tu navegador</li>
                        <li>Aseg√∫rate de permitir el acceso a la c√°mara</li>
                        <li>Recarga la p√°gina e intenta nuevamente</li>
                    </ol>
                    <button onclick="location.reload()" style="
                        padding: 12px 30px;
                        background: #3498db;
                        color: white;
                        border: none;
                        border-radius: 50px;
                        font-size: 1rem;
                        cursor: pointer;
                        width: 100%;
                    ">
                        RECARGAR P√ÅGINA
                    </button>
                `;
            });
        }

        // ================= AUDIO =================
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('üéµ Audio inicializado');
                
                // Reproducir sonido de inicio
                playSound(523.25, 0.1, 'sine', 0.1); // Do
                setTimeout(() => playSound(659.25, 0.1, 'sine', 0.1), 100); // Mi
                setTimeout(() => playSound(783.99, 0.2, 'sine', 0.1), 200); // Sol
            } catch (error) {
                console.warn('‚ö†Ô∏è Audio no disponible:', error);
            }
        }

        function playSound(frequency, duration, type = 'sine', volume = 0.3) {
            if (!soundEnabled || !audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                const now = audioContext.currentTime;
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(volume, now + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + duration);
                
                oscillator.start(now);
                oscillator.stop(now + duration);
            } catch (error) {
                console.log('‚ö†Ô∏è Error de audio:', error);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('sound-btn');
            btn.innerHTML = soundEnabled ? 'üîä' : 'üîá';
            btn.style.background = soundEnabled ? 'rgba(52, 152, 219, 0.9)' : 'rgba(231, 76, 60, 0.9)';
            
            playSound(800, 0.1, 'sine', 0.2);
        }

        // ================= AR =================
        function initARExperience() {
            console.log('üîÑ Iniciando experiencia AR...');
            
            // Ocultar pantalla de carga
            document.getElementById('loading-screen').style.display = 'none';
            
            // Crear escena AR
            const arContainer = document.getElementById('ar-scene');
            arContainer.innerHTML = `
                <a-scene 
                    mindar-image="imageTargetSrc: ./marker.mind; autoStart: true; uiScanning: no; uiLoading: no; uiError: no;"
                    vr-mode-ui="enabled: false"
                    device-orientation-permission-ui="enabled: false"
                    embedded
                    renderer="colorManagement: true; alpha: true; antialias: true; precision: medium;"
                    loading-screen="enabled: false"
                >
                    <a-assets>
                        <video 
                            id="ar-video" 
                            src="./asset.mp4" 
                            preload="auto"
                            loop 
                            muted 
                            playsinline 
                            crossorigin="anonymous"
                        ></video>
                    </a-assets>
                    
                    <a-camera 
                        position="0 0 0" 
                        look-controls="enabled: false"
                        wasd-controls="enabled: false"
                    ></a-camera>
                    
                    <a-entity 
                        id="target-entity" 
                        mindar-image-target="targetIndex: 0"
                    >
                        <a-plane
                            src="#ar-video"
                            width="1.78"
                            height="1"
                            position="0 0 0"
                            rotation="0 0 0"
                            material="shader: flat; transparent: true;"
                        ></a-plane>
                    </a-entity>
                </a-scene>
            `;
            
            // Esperar a que la escena se cargue
            setTimeout(() => {
                arScene = document.querySelector('a-scene');
                if (arScene) {
                    arScene.addEventListener('loaded', setupARScene);
                    arScene.addEventListener('renderstart', () => {
                        console.log('üé¨ Renderizado AR iniciado');
                        document.getElementById('ar-scene').style.opacity = '1';
                        showARControls();
                    });
                }
            }, 100);
        }

        function setupARScene() {
            console.log('‚úÖ Escena AR cargada');
            
            const targetEntity = document.querySelector('#target-entity');
            const video = document.querySelector('#ar-video');
            
            if (targetEntity && video) {
                // Evento cuando se detecta el marcador
                targetEntity.addEventListener('targetFound', () => {
                    console.log('üéØ Marcador detectado');
                    document.getElementById('detection-indicator').innerHTML = '‚úÖ Marcador detectado';
                    document.getElementById('detection-indicator').style.borderColor = '#4CAF50';
                    
                    // Reproducir video
                    video.play().catch(e => {
                        console.log('‚ö†Ô∏è Error al reproducir video:', e);
                        video.muted = true;
                        video.play();
                    });
                    
                    // Sonido de detecci√≥n
                    playSound(1200, 0.3, 'triangle', 0.2);
                });
                
                // Evento cuando se pierde el marcador
                targetEntity.addEventListener('targetLost', () => {
                    console.log('‚ùå Marcador perdido');
                    document.getElementById('detection-indicator').innerHTML = 'üîç Buscando marcador...';
                    document.getElementById('detection-indicator').style.borderColor = '#FF9800';
                    
                    // Pausar video
                    video.pause();
                });
                
                // Mostrar indicador
                document.getElementById('detection-indicator').style.display = 'block';
            }
        }

        function showARControls() {
            document.getElementById('exit-btn').style.display = 'flex';
            document.getElementById('ar-controls').style.display = 'flex';
        }

        function showHelp() {
            playSound(600, 0.1, 'sine', 0.2);
            
            const indicator = document.getElementById('detection-indicator');
            indicator.innerHTML = 'üì± Apunta la c√°mara al im√°n tur√≠stico';
            indicator.style.borderColor = '#3498db';
            
            setTimeout(() => {
                indicator.innerHTML = 'üîç Buscando marcador...';
                indicator.style.borderColor = '#FF9800';
            }, 3000);
        }

        function exitARExperience() {
            playSound(400, 0.2, 'sawtooth', 0.2);
            
            // Ocultar controles
            document.getElementById('exit-btn').style.display = 'none';
            document.getElementById('ar-controls').style.display = 'none';
            document.getElementById('detection-indicator').style.display = 'none';
            
            // Ocultar escena AR
            document.getElementById('ar-scene').style.opacity = '0';
            
            // Detener video si existe
            const video = document.querySelector('#ar-video');
            if (video) {
                video.pause();
                video.currentTime = 0;
            }
            
            // Limpiar escena
            setTimeout(() => {
                document.getElementById('ar-scene').innerHTML = '';
                
                // Mostrar pantalla de carga
                document.getElementById('loading-screen').style.display = 'flex';
                
                // Solicitar permisos nuevamente despu√©s de 1 segundo
                setTimeout(showPermissionScreen, 1000);
            }, 500);
        }

        // ================= MANEJADORES DE ERROR =================
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            
            // Mostrar mensaje de error amigable
            if (e.error && e.error.message && e.error.message.includes('MindAR')) {
                document.getElementById('loading-screen').innerHTML = `
                    <div style="text-align: center; color: white; padding: 20px;">
                        <div style="font-size: 60px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h2 style="margin-bottom: 15px;">Error de Configuraci√≥n AR</h2>
                        <p style="margin-bottom: 20px; opacity: 0.8;">
                            Hay un problema con la configuraci√≥n de Realidad Aumentada.
                        </p>
                        <button onclick="location.reload()" style="
                            padding: 12px 30px;
                            background: #3498db;
                            color: white;
                            border: none;
                            border-radius: 50px;
                            font-size: 1rem;
                            cursor: pointer;
                        ">
                            REINTENTAR
                        </button>
                    </div>
                `;
            }
        });

        // ================= MANEJAR CAMBIOS DE VISIBILIDAD =================
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Pausar video cuando la pesta√±a no est√° visible
                const video = document.querySelector('#ar-video');
                if (video && !video.paused) {
                    video.pause();
                }
            }
        });
    </script>
</body>
</html>
